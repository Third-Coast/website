<form name="uploadData" method="POST" action="[/manage/edit/$item::_model/$item:@id]" class="editor" autocomplete="off">
  <style type="text/css" media="screen">
    /* <![CDATA[ */
    audio {display:none;}
    fieldset div.group {width:33%;}
    fieldset.media ul.inline li {width:20%;}
    fieldset.media ul.inline li img {width:100%;opacity:0.5;}
    fieldset.media input[type=checkbox]:checked + label img{opacity:1;}
    /* ]]> */
  </style>
  <input type="hidden" name="vertex[@][id]" value="[$item:@id]" />
  <input type="hidden" name="vertex[@][created]" value="[$item:@created]" />
  
  <fieldset>
    <legend class="caps-lock">Edit</legend>
    <h5 class="[status $item:status:type ragleft]"><em>[$item:status:text]</em></h5>
    <input type="text" name="vertex[@][title]" value="[$item:@title]" id="title" class="required text"/>
    <label for="title">Title</label>  

    <textarea name="vertex[abstract][CDATA]" rows="8" cols="40" id="description" class="required text">[$item:abstract]</textarea>
    <label for="description">Description</label>  
    
    <div class="group left">
      <input type="text" name="vertex[location][CDATA]" value="[$item:location]" id="location" class="required text" />
      <label for="location">Origin Country</label>  
    </div>
    
    <div class="group left">
      <input type="text" name="vertex[premier][CDATA]" value="[$item:premier]" id="premier" class="required text" />
      <label for="premier">Premier Location</label>
    </div>
    
    <div class="group left">
      <input type="text" name="vertex[premier][@][date]" value="[$item:premier:@date]" id="premier_date" class="required text" />
      <label for="premier_date">Premier Date</label>
    </div>
  </fieldset>
  
  <fieldset class="media">
    <legend class="caps-lock">Media</legend>
    
    <input type="text" readonly="readonly" name="[vertex[media][$item:audio:index][@][src]]" value="[$item:audio:src]" />
    <input type="hidden" name="[vertex[media][$item:audio:index][@][type]]" value="[$item:audio:type]" class="file"/>
    <input type="hidden" name="[vertex[media][$item:audio:index][@][mark]]" value="[$item:audio:type]" class="file"/>
    
    <audio src="[http://tmp.s3.amazonaws.com/3rdcoast-features/mp3s/$item:audio:src]"  onloadedmetadata="Player.attach(this);" controls="controls" preload="[$item:audio:preload]">[$item:audio:src]</audio>

    <hr/>

    <ul class="inline">
      <!-- iterate item:thumbnails -->
      <li>
        <input type="checkbox" name="[vertex[media][$index][@][src]]" value="[$src]" checked="true" id="[:$index]"/>
        <label for="[:$index]">
          <img src="[http://tmp.s3.amazonaws.com/$src]"/>
        </label>
      </li>
    </ul>
    
    
    <input type="file" name="uploader" id="uploader" data-url="/manage/upload"  accept="image/jpeg, image/jpg, audio/mp3, audio/m4a" class="margins"/>
  </fieldset>
  
  <fieldset class="secondary spectra">
    <legend class="caps-lock interactive" onclick="this.parentNode.classList.toggle('open');this.classList.toggle('active');">Spectra</legend>
    <!-- iterate item:spectra -->
    <label class="range container">
      <h4>[$title]</h4>
      <span>[$item:@from]</span>
      <input type="range" min="0" max="100" name="[vertex[spectra][CDATA][$item:@id]]" value="[$value]" data-index="0"/>
      <span>[$item:@to]</span>
    </label>
    
  </fieldset>
  
  <button type="submit" class="margins">Submit</button>
  
  <hr/>
  
  <fieldset>
    <legend class="caps-lock">References</legend>
    <!--iterate references -->
    <div class="listed padded">
      <sup class="normal capitalize small">[$edge:@type]</sup>
      <h2><a href="[/manage/edit/find/$@id]">[$@title]</a></h2>
      <p>[$abstract]</p>
      <a class="button margins ghost" href="[#/manage/edge/remove/$edge:@type/$edge:@vertex/$@id]">[Unlink $@title]</a>
    </div>
    <a class="button margins" href="[#/manage/edge/add/producer/$item:@id]">Add Reference</a>
  </fieldset>
  
  
  
  
  <script type="text/javascript">
  // <![CDATA[
    function Spectra(labels) {
      var total = labels.length;
      for (var i = 0; i < total; i++) {
        labels[i].dataset.index = (i / total);
        this.color.call(labels[i]);
        labels[i].addEventListener('input', this.color);
      }
    }
    
    Spectra.prototype.color = function () {
      var value = parseInt(this.value, 10);
      var intensity = (value / 100 );
      var color = {
        h: Math.round(parseFloat(this.dataset.index, 10) * 255), 
        s: Math.round((Math.abs(50 - value) / 100) * 200) + '%',
        l: Math.round(((Math.abs(100 - value) / 100) * 50) + 40) + '%'
      };

      this.parentNode.style.backgroundColor = 'hsla({h}, {s}, {l}, 0.25)'.format(color);
    }
    
    var player = null;
    
    bloc.prepare(function () {
      
      var uploader = new Upload(document.getElementById('uploader'));
      
      uploader.addRoutine('audio', function (file) {
        // make sure there is not a file currently associated with the feature
        if (document.querySelectorAll('input.file[value="audio"]').length > 0) {
          throw new Error('Only one audio file allowed. Unlink the one you are using now.');
        }
      });
      
      uploader.addRoutine('image', function (file) {
        var reader = new FileReader();
      
        reader.onload = function (evt) {
          console.log(evt);
          var img = document.createElement('img');
              img.src = evt.target.result;

          this.parentNode.insertBefore(img, this);
        }.bind(this.input);
      
        reader.readAsDataURL(this.input.files[0]);
      });
      
      var spectra_object = new Spectra(document.querySelectorAll('fieldset.spectra label input'));
    });
  //]]>
  </script>
  
</form>