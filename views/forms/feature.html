<div>
  <form name="uploadData" method="POST" action="[/manage/edit/$item:_model/$item:@id]" class="editor" autocomplete="off">
  
    <!-- insert  views/forms/partials/title-description.html -->
    
    <fieldset>
      <legend>Additional Details</legend>
      <div class="group left">
        <input type="text" name="vertex[location][CDATA]" value="[$item:location]" id="location" class="required text" />
        <label for="location">Origin Country</label>  
      </div>
    
      <div class="group left">
        <input type="text" name="vertex[premier][CDATA]" value="[$item:premier]" id="premier" class="required text" />
        <label for="premier">Premier Location</label>
      </div>
    
      <div class="group left">
        <input type="text" name="vertex[premier][@][date]" value="[$item:premier:@date]" id="premier_date" class="required text" />
        <label for="premier_date">Premier Date</label>
      </div>
    </fieldset>
  
    <fieldset class="media">
      <legend class="caps-lock">Media</legend>
      <dl class="inline">
        <dt>Audio</dt>
        <audio src="[http://s3.amazonaws.com/$item:audio:src]"  onloadedmetadata="startFormPlayer(this);" controls="controls" preload="metadata">Audio</audio>
        <dd class="audio">
          <input type="hidden" class="type" name="[vertex[media][$item:audio:index][@][type]]" value="[$item:audio:type]" />
          <input type="hidden" class="mark" name="[vertex[media][$item:audio:index][@][mark]]" value="[$item:audio:mark]" />
          <p class="info">[$item:audio:message]</p>
          <label>
            <input type="checkbox" class="src" name="[vertex[media][$item:audio:index][@][src]]"  value="[$item:audio:src]" checked="checked" />
            <span>Keep Audio</span>
          </label>
        </dd>

        <dt>Images</dt>
        <!-- iterate item:thumbnails -->
        <!-- insert views/forms/partials/media.html -->
      </dl>

      <input type="file" name="uploader" id="uploader" data-url="/manage/upload.xml"  accept="image/jpeg, image/jpg, audio/mp3, audio/mp4" class="margins"/>
    </fieldset>
  
    <fieldset class="secondary spectra">
      <legend class="caps-lock interactive" onclick="this.parentNode.classList.toggle('open');this.classList.toggle('active');">Spectra</legend>
      
      <!-- iterate item:spectra -->
      <label class="range container">
        <h4>[$title]</h4>
        <span>[$item:@from]</span>
        <input type="range" min="0" max="100" name="[vertex[spectra][@][$item:@id]]" value="[$value]" data-index="0"/>
        <span>[$item:@to]</span>
      </label>
    
    </fieldset>
  
    <fieldset class="edges">
      <legend class="caps-lock">Edges</legend>
      <p class="info padded margins">Edges are links between two discrete elements. This list contains 'Referenced' edges, meaning that the items shown below reference (or claim a certain amount of responsibility for) this feature. Another way to visualize the direction of responsibility, if you were creating a collection, 'who collects what?' If features are responsible for producers, then a feature has a collection of producers as the terminal point. If producers are responsible for features, then a producer has a collection of features at the terminus (preferred).</p>
      
      <!-- iterate references -->
      <!-- insert views/forms/partials/edge.html -->
      
      <button class="showmodal margins">+ Add Referenced Edge (make this xhr)</button>
    </fieldset>

    <button type="submit" class="margins">Save your Work</button>
    
  </form> 

  <!-- insert views/forms/edge.html -->
  
  <script type="text/javascript">
    // <![CDATA[
    
    function startFormPlayer(audio_element) {
      Player.attach(audio_element);
      audio_element.parentNode.querySelector('input.mark').value = audio_element.duration;
    }
  
    var player = null;
  
    
    
    bloc.prepare(function () {
    
      var uploader = new Upload(document.getElementById('uploader'));
    
      document.querySelector('button.showmodal').addEventListener('click', function (evt) {
        evt.preventDefault();
        if (! this.reference) {
          var form_modal = document.querySelector('form.modal');
          form_modal.addEventListener('submit', function (evt) {
            evt.preventDefault();
            var xhr = new XMLHttpRequest();
                xhr.overrideMimeType('text/xml');
                xhr.addEventListener('load', function (evt) {
                  var edge_container = document.querySelector('fieldset.edges');
                  var new_edge = evt.target.responseXML.querySelector("dl.listed.container");

                  edge_container.insertBefore(new_edge, edge_container.querySelector('button'));
                  
                  // close the modal
                  form_modal.querySelector('button.close').dispatchEvent(new Event('click', {
                    cancelable: true
                  }));
                });
                xhr.open("POST", this.action);
                xhr.send(new FormData(this));
          })
          this.reference = new Modal(form_modal);
        }
        this.blur();
        this.reference.show();
        
        this.reference.element.querySelector('select').focus();

      
      });
    
    
      uploader.addRoutine('audio', function (file) {
        // make sure there is not a file currently associated with the feature
        
        if (document.querySelectorAll('dd.audio input.src[value]').length > 0) {
          throw new Error('Only one audio file allowed. Unlink the one you are using now.');
        }
      });
    
      uploader.addRoutine('image', function (file) {
        var reader = new FileReader();
    
        reader.onload = function (evt) {
          // this is the progress default holder thing.
          
          var dd = document.querySelector('fieldset.media dl').appendChild(document.createElement('dd'));
              dd.title = file.name;
        
          var label = dd.appendChild(document.createElement('label'));
        
          var img = label.appendChild(document.createElement('img'));
              img.src   = evt.target.result;    
        };
      
        reader.readAsDataURL(file);
      });
    
      uploader.addEvent('load', function (evt) {
        var media = this.responseXML.documentElement.querySelector('dd.media');
        if (media.getAttribute('data-type') == 'image') {
          document.querySelector('fieldset.media dl').appendChild(media);
        
        } else if (media.getAttribute('data-type') == 'audio') {
        
          document.querySelectorAll('fieldset.media dd.audio input').forEach(function (input) {
            var stub =  media.querySelector('input.'+input.className)
            input.value = stub.getAttribute('value');
            input.name  = stub.getAttribute('name');
          });
          var message = document.querySelector('dd.audio p');
          if (message) {
            message.textContent = "Uploaded Track"
            message.className = "success";
            
          }
          document.querySelector('fieldset.media audio').src = "http://s3.amazonaws.com/" + media.querySelector('input.src').value;
        }

      });
    
      var spectra_object = new Spectra(document.querySelectorAll('fieldset.spectra label input'));
    });
  //]]>
  </script>
  
  <style type="text/css" media="screen">
    /* <![CDATA[ */
    fieldset div.group {width:33%;}
    fieldset.media input[type=checkbox]:checked + label img{opacity:1;}
    fieldset.media dd.image input[type=checkbox]:not(:checked):after {content:'Detached';font-size:0.65em;line-height:0;top:-0.5em;left:1.75em;position:relative;}
    fieldset.media dt {
      padding:0.5em 1em;
      margin:0 0 0.5em;
      border-bottom:1px solid #eee;
    }
    fieldset.media p.info + label {display:none;}
    /* ]]> */
  </style>
</div>