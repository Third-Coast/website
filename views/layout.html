<!DOCTYPE html>
<html>
  <head>
    <title>[$title]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta charset="utf-8" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Third Coast International Audio Festival"/>
    <script type="text/javascript">
      // <![CDATA[
      window.bloc = (function(d,w,c,q,t) {
        return { 
          tag: function (async) {var s = d.createElement('script');s.type='text/javascript';s.async=async;return s;},
          embed: function() {for (var i=0; i < arguments.length; i++) {var s = this.tag(false);s.src=s.src=arguments[i];s.onload = this.load; q.push(s);} return this;},
          track: function (src) { for (var i=0; i < arguments.length; i++) {t.push(this.tag(arguments[i], true));} return this;},
          load: function(){ if (q.length > 0) {d.body.appendChild(q.shift()); } else { for (var k in c) {w.bloc.execute(k, null)}; while(t.length > 0) d.body.appendChild(t.shift());}},
          execute: function(k, a) { if (c[k]) return c[k].call(this, a);},
          prepare: function(k, f) {if (typeof f === 'function') c[k] = f; else return c[k] || function() {};}
      };}(document, window, {}, [], []));

      bloc.embed('/js/bloc.js');
      bloc.prepare('autoload', function (auto) {
        document.querySelectorAll('noscript').forEach(function (elem) {
          var swap = document.createElement('div');
          elem.parentNode.replaceChild(swap, elem);
          var obj = new window[elem.id](swap, elem.dataset);
          if (auto === null) {
            bloc.prepare(elem.id, bloc.prepare(elem.id).bind(obj));
          } else {
            window.bloc.execute.call(obj, elem.id);
          }
        });
        return this;
      });
      
      bloc.prepare('Player', function (audio) {
        if (audio instanceof Element) {
          this.attach(audio);
        } 
        return this;
      });
      // ]]>
    </script>
    <link rel="shortcut icon" href="/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/css/austere.css" />
    <link rel="stylesheet" type="text/css" href="/css/layout.css" />
  </head>
  
  <body class="[$_controller $_action unloaded]" data-user="[$user]">
    <!-- replace helper -->
    <header class="container">
      <nav>
        <ul class="inline">
          <li class="home"><a href="/">home</a></li>
          <li><a href="/overview/library">Library</a></li>
          <li><a href="/overview/conference">Conference</a></li>
          <li><a href="#">Events</a></li>
          <li><a href="/overview/competition">Competitions</a></li>
          <li><a href="#">Subscribe</a></li>
          <li><a href="https://donatenow.networkforgood.org/ThirdCoast">Donate</a></li>
          <li><input type="text" name="search" value="" placeholder="search" /></li>
        </ul>
      </nav>
      <noscript id="Player" data-queue="">The Third Coast Festival Audio Player Requires Javascript</noscript>
    </header>
        
    <main class="content container">
      <!-- replace content nextSibling -->
      <article>
        <style type="text/css" media="screen">
          /* <![CDATA[ */
          
          #Library {
            width:100%;
            background-color:#46827e;
            padding:0;
          }


          #Library rect {
            fill:#5b9b98;
            transition:fill-opacity 0.5s;      
          }
          #Library rect:hover {
            fill-opacity:0.5;
          }
          /* ]]> */
        </style>
        
        <!-- insert views/forms/partials/search.html -->
        
        <div class="container">
          <div id="Library" data-tokens="[$tokens]">
          </div>
        </div>
        <script type="text/javascript" async="true">
        // <![CDATA[
          

        bloc.prepare('splash', function () {
          
          var library = document.getElementById('Library');
          var titles = document.querySelector('#Player .display p');

          var timer = 0;

          var http = new Request({
            load: function (evt) {
              if (evt.target.status >= 400) return;
              var title = evt.target.responseXML.documentElement.querySelector('main article h1').innerHTML;
              titles.innerHTML = '<h2>' + title + '</h2>';;
            }
          });
          
          var width = 600;
          var height = 400;
          var svg = new SVG(library, {
            height: '100%',
            width: '100%',
            viewBox: '0 0 {0} {1}'.format(width, height)
          });

              
              
          var spread = Animate(function (element) {
            var ratio = Math.min(1, 1 - Math.pow(1 - (Date.now() - this.start) / this.duration, 5)); // float % animation complete 
            // var x = ratio >= 1 ? this.to[0] : ( ratio * ( this.to[0] - this.from[0] ) ) + this.from[0];
            var y = ratio >= 1 ? this.to[1] : ( ratio * ( this.to[1] - this.from[1] ) ) + this.from[1];
            // var w = ratio >= 1 ? this.to[2] : ( ratio * ( this.to[2] - this.from[2] ) ) + this.from[2];
            var h = ratio >= 1 ? this.to[3] : ( ratio * ( this.to[3] - this.from[3] ) ) + this.from[3];
            
            // element.setAttribute('x', x);
            element.setAttribute('y', y);
            // element.setAttribute('width', w);
            element.setAttribute('height', h);

            return (ratio < 1);
          });
          
          
          svg.element.addEventListener('mouseover', function (evt) {
            if (evt.target.nodeName.toLowerCase() === 'rect') {

              clearTimeout(timer);
              timer = setTimeout(function () {
                http.get('/explore/detail/' + evt.target.id + '.xml');
              }, 200);
            }
          }, false);
          
          
          var matrix = {};
          
          var tokens = library.dataset.tokens.split(' ');
          
          var w = Math.ceil(Math.sqrt(tokens.length));
          var h = w / 10;

          var rows = 0;
          var cols = width / w;
          


          tokens.forEach(function (token, idx) {
            var start = [0, 0, 0, 0];
            matrix[token] = svg.createElement('rect', {
              'height': 0,
              'id': token,
              'x': ((idx % cols) * w),
              'width': w
            });
              
            
            if (idx%2) {
              spread.start(matrix[token], {
                duration: Math.floor(idx * Math.random() + rows * 25),
                from: start,
                to: [((idx % cols) * w), (rows * h), w, h]
              });
            } else {
              setTimeout(function (idx, cols, rows, w, h) {
                var anim = spread.start(this, {
                  duration: Math.floor(idx * Math.random() + rows * 55),
                  from: start,
                  to: [((idx % cols) * w), (rows * h), w, h]
                });
                if (idx % 5 === 0) {
                  anim.stop();
                }
              }.bind(matrix[token], idx, cols, rows, w, h), 150);
            }
              
            if (idx % cols === 0) {
              rows++;
            }
          });
        });
        // ]]>
        </script>
        
      </article>
    </main>
    
    <!-- insert views/pages/footer.html -->
    
    <script type="text/javascript">window.bloc.load();</script>
  </body>
</html>